<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.BetRecordMapper">
    <resultMap type="BetRecord" id="BetRecordResult">
        <result property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="betAmount" column="bet_amount"/>
        <result property="validBetAmount" column="valid_bet_amount"/>
        <result property="canWinAmount" column="can_win_amount"/>
        <result property="betContent" column="bet_content"/>
        <result property="displayBetContent" column="display_bet_content"/>
        <result property="betOdds" column="bet_odds"/>
        <result property="betAdditionalOdds" column="bet_additional_odds"/>
        <result property="betAdditionalOdds1" column="bet_additional_odds1"/>
        <result property="platformId" column="platform_id"/>
        <result property="platformUserId" column="platform_user_id"/>
        <result property="lotteryId" column="lottery_id"/>
        <result property="issueNo" column="issue_no"/>
        <result property="playTypeName" column="play_type_name"/>
        <result property="win" column="win"/>
        <result property="winLoseAmount" column="win_lose_amount"/>
        <result property="playTypeCode" column="play_type_code"/>
        <result property="playTypeDetailCode" column="play_type_detail_code"/>
        <result property="betNo" column="bet_no"/>
        <result property="status" column="status"/>
        <result property="cancelType" column="cancel_type"/>
        <result property="betTime" column="bet_time"/>
        <result property="countTime" column="count_time"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
        <result property="singleTimeBetAmount" column="single_time_bet_amount"/>
        <result property="singleTimeCount" column="single_time_count"/>
        <result property="winAmount" column="win_amount"/>
        <result property="idStr" column="idStr"/>
        <result property="platformName" column="platform_name"/>
        <result property="lotteryName" column="lottery_name"/>
        <result property="rewardStatus" column="reward_status"/>
        <result property="betPosition" column="bet_position"/>
        <result property="displayBetPosition" column="display_bet_position"/>
    </resultMap>

    <sql id="selectBetRecordVo">
        select *
        from t_bet_record
    </sql>

    <select id="selectBetRecordList" parameterType="BetRecord" resultMap="BetRecordResult">
        select *, id as idStr
        from t_bet_record
        <where>
            <if test="id != null">
                and id = #{id}
            </if>
            <if test="userId != null">
                and user_id = #{userId}
            </if>
            <if test="betAmount != null">
                and bet_amount = #{betAmount}
            </if>
            <if test="canWinAmount != null">
                and can_win_amount = #{canWinAmount}
            </if>
            <if test="betContent != null  and betContent != ''">
                and bet_content = #{betContent}
            </if>
            <if test="displayBetContent != null  and displayBetContent != ''">
                and display_bet_content = #{displayBetContent}
            </if>
            <if test="betOdds != null">
                and bet_odds = #{betOdds}
            </if>
            <if test="betAdditionalOdds != null">
                and bet_additional_odds = #{betAdditionalOdds}
            </if>
            <if test="platformId != null">
                and platform_id = #{platformId}
            </if>
            <if test="platformUserId != null">
                and platform_user_id = #{platformUserId}
            </if>
            <if test="lotteryId != null">
                and lottery_id = #{lotteryId}
            </if>
            <if test="issueNo != null  and issueNo != ''">
                and issue_no = #{issueNo}
            </if>
            <if test="playTypeName != null  and playTypeName != ''">
                and play_type_name like concat('%', #{playTypeName}, '%')
            </if>
            <if test="win != null">
                and win = #{win}
            </if>
            <if test="winLoseAmount != null">
                and win_lose_amount = #{winLoseAmount}
            </if>
            <if test="playTypeCode != null">
                and play_type_code = #{playTypeCode}
            </if>
            <if test="playTypeDetailCode != null  and playTypeDetailCode != ''">
                and play_type_detail_code = #{playTypeDetailCode}
            </if>
            <if test="betNo != null  and betNo != ''">
                and bet_no = #{betNo}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="cancelType != null">
                and cancel_type = #{cancelType}
            </if>
            <if test="betTime != null">
                and bet_time = #{betTime}
            </if>
            <if test="countTime != null">
                and count_time = #{countTime}
            </if>
            <if test="createBy != null">
                and create_by = #{createBy}
            </if>
            <if test="updateBy != null">
                and update_by = #{updateBy}
            </if>
            <if test="rewardStatus != null">
                and reward_status = #{rewardStatus}
            </if>
            <if test="platformUserIdList != null and platformUserIdList.size() > 0">
                and platform_user_id in
                <foreach collection="platformUserIdList" open="(" close=")" separator="," item="platformUserId">
                    #{platformUserId}
                </foreach>
            </if>
            <if test="statusList != null and statusList.size() > 0">
                and status in
                <foreach collection="statusList" open="(" close=")" separator="," item="status">
                    #{status}
                </foreach>
            </if>
            <if test="beginTime != null">
                <choose>
                    <when test="timeType == 1">
                        and bet_time &gt;= #{beginTime}
                    </when>
                    <when test="timeType == 2">
                        and count_time &gt;= #{beginTime}
                    </when>
                    <otherwise>
                        and bet_time &gt;= #{beginTime}
                    </otherwise>
                </choose>
            </if>
            <if test="endTime != null">
                <choose>
                    <when test="timeType == 1">
                        and bet_time &lt;= #{endTime}
                    </when>
                    <when test="timeType == 2">
                        and count_time &lt;= #{endTime}
                    </when>
                    <otherwise>
                        and bet_time &lt;= #{endTime}
                    </otherwise>
                </choose>
            </if>
        </where>
        order by bet_time desc
    </select>

    <select id="selectBetRecordById" parameterType="Long" resultMap="BetRecordResult">
        <include refid="selectBetRecordVo"/>
        where id = #{id}
    </select>

    <insert id="insertBetRecord" parameterType="BetRecord" useGeneratedKeys="true" keyProperty="id">
        insert into t_bet_record
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">
                user_id,
            </if>
            <if test="betAmount != null">
                bet_amount,
            </if>
            <if test="canWinAmount != null">
                can_win_amount,
            </if>
            <if test="betContent != null and betContent != ''">
                bet_content,
            </if>
            <if test="displayBetContent != null and displayBetContent != ''">
                display_bet_content,
            </if>
            <if test="betOdds != null">
                bet_odds,
            </if>
            <if test="betAdditionalOdds != null">
                bet_additional_odds,
            </if>
            <if test="platformId != null">
                platform_id,
            </if>
            <if test="platformUserId != null">
                platform_user_id,
            </if>
            <if test="lotteryId != null">
                lottery_id,
            </if>
            <if test="issueNo != null and issueNo != ''">
                issue_no,
            </if>
            <if test="playTypeName != null and playTypeName != ''">
                play_type_name,
            </if>
            <if test="win != null">
                win,
            </if>
            <if test="winLoseAmount != null">
                win_lose_amount,
            </if>
            <if test="playTypeCode != null">
                play_type_code,
            </if>
            <if test="playTypeDetailCode != null and playTypeDetailCode != ''">
                play_type_detail_code,
            </if>
            <if test="betNo != null">
                bet_no,
            </if>
            <if test="status != null">
                status,
            </if>
            <if test="cancelType != null">
                cancel_type,
            </if>
            <if test="betTime != null">
                bet_time,
            </if>
            <if test="countTime != null">
                count_time,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="updateTime != null">
                update_time,
            </if>
            <if test="createBy != null">
                create_by,
            </if>
            <if test="updateBy != null">
                update_by,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">
                #{userId},
            </if>
            <if test="betAmount != null">
                #{betAmount},
            </if>
            <if test="canWinAmount != null">
                #{canWinAmount},
            </if>
            <if test="betContent != null and betContent != ''">
                #{betContent},
            </if>
            <if test="displayBetContent != null and displayBetContent != ''">
                #{displayBetContent},
            </if>
            <if test="betOdds != null">
                #{betOdds},
            </if>
            <if test="betAdditionalOdds != null">
                #{betAdditionalOdds},
            </if>
            <if test="platformId != null">
                #{platformId},
            </if>
            <if test="platformUserId != null">
                #{platformUserId},
            </if>
            <if test="lotteryId != null">
                #{lotteryId},
            </if>
            <if test="issueNo != null and issueNo != ''">
                #{issueNo},
            </if>
            <if test="playTypeName != null and playTypeName != ''">
                #{playTypeName},
            </if>
            <if test="displayPlayTypeName != null">
                #{displayPlayTypeName},
            </if>
            <if test="win != null">
                #{win},
            </if>
            <if test="winLoseAmount != null">
                #{winLoseAmount},
            </if>
            <if test="playTypeCode != null">
                #{playTypeCode},
            </if>
            <if test="playTypeDetailCode != null and playTypeDetailCode != ''">
                #{playTypeDetailCode},
            </if>
            <if test="betNo != null">
                #{betNo},
            </if>
            <if test="status != null">
                #{status},
            </if>
            <if test="cancelType != null">
                #{cancelType},
            </if>
            <if test="betTime != null">
                #{betTime},
            </if>
            <if test="countTime != null">
                #{countTime},
            </if>
            <if test="createTime != null">
                #{createTime},
            </if>
            <if test="updateTime != null">
                #{updateTime},
            </if>
            <if test="createBy != null">
                #{createBy},
            </if>
            <if test="updateBy != null">
                #{updateBy},
            </if>
        </trim>
    </insert>

    <update id="updateBetRecord" parameterType="BetRecord">
        update t_bet_record
        <trim prefix="SET" suffixOverrides=",">
            <if test="userId != null">
                user_id = #{userId},
            </if>
            <if test="betAmount != null">
                bet_amount = #{betAmount},
            </if>
            <if test="canWinAmount != null">
                can_win_amount = #{canWinAmount},
            </if>
            <if test="betContent != null and betContent != ''">
                bet_content = #{betContent},
            </if>
            <if test="displayBetContent != null and displayBetContent != ''">
                display_bet_content = #{displayBetContent},
            </if>
            <if test="betOdds != null">
                bet_odds = #{betOdds},
            </if>
            <if test="betAdditionalOdds != null">
                bet_additional_odds = #{betAdditionalOdds},
            </if>
            <if test="platformId != null">
                platform_id = #{platformId},
            </if>
            <if test="platformUserId != null">
                platform_user_id = #{platformUserId},
            </if>
            <if test="lotteryId != null">
                lottery_id = #{lotteryId},
            </if>
            <if test="issueNo != null and issueNo != ''">
                issue_no = #{issueNo},
            </if>
            <if test="playTypeName != null and playTypeName != ''">
                play_type_name = #{playTypeName},
            </if>
            <if test="win != null">
                win = #{win},
            </if>
            <if test="winLoseAmount != null">
                win_lose_amount = #{winLoseAmount},
            </if>
            <if test="playTypeCode != null">
                play_type_code = #{playTypeCode},
            </if>
            <if test="playTypeDetailCode != null and playTypeDetailCode != ''">
                play_type_detail_code = #{playTypeDetailCode},
            </if>
            <if test="betNo != null">
                bet_no = #{betNo},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="cancelType != null">
                cancel_type = #{cancelType},
            </if>
            <if test="betTime != null">
                bet_time = #{betTime},
            </if>
            <if test="countTime != null">
                count_time = #{countTime},
            </if>
            <if test="createTime != null">
                create_time = #{createTime},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="createBy != null">
                create_by = #{createBy},
            </if>
            <if test="updateBy != null">
                update_by = #{updateBy},
            </if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteBetRecordById" parameterType="Long">
        delete
        from t_bet_record
        where id = #{id}
    </delete>

    <delete id="deleteBetRecordByIds" parameterType="String">
        delete
        from t_bet_record where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="statBetRecord" parameterType="com.ruoyi.system.domain.BetRecord"
            resultType="com.ruoyi.system.pojo.BetRecordStatVO">
        select count(*)                as totalCount
             , count(distinct user_id) as totalBetUserCount
             , sum(bet_amount)         as totalAmount
             , sum(valid_bet_amount)   as totalValidBetAmount
             , sum(win_lose_amount)    as winLoseAmount
             , sum(win_amount)         as totalWinAmount
        from t_bet_record
        <where>
            <if test="platformId != null">
                and platform_id = #{platformId}
            </if>
            <if test="lotteryId != null">
                and lottery_id = #{lotteryId}
            </if>
            <if test="userId != null">
                and user_id = #{userId}
            </if>
            <if test="issueNo != null and issueNo != ''">
                and issue_no = #{issueNo}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="playTypeCode != null">
                and play_type_code = #{playTypeCode}
            </if>
            <if test="playTypeDetailCode != null and playTypeDetailCode != ''">
                and play_type_detail_code = #{playTypeDetailCode}
            </if>
            <if test="beginTime != null">
                and create_time &gt;= #{beginTime}
            </if>
            <if test="endTime != null">
                and create_time &lt;= #{endTime}
            </if>
        </where>
    </select>

    <select id="statBetRecordAndGroupByUserId" parameterType="com.ruoyi.system.domain.BetRecord"
            resultType="com.ruoyi.system.pojo.BetRecordStatVO">
        select user_id               as userId
             , count(*)              as totalCount
             , sum(bet_amount)       as totalAmount
             , sum(valid_bet_amount) as totalValidBetAmount
             , sum(win_lose_amount)  as winLoseAmount
             , sum(win_amount)       as totalWinAmount
        from t_bet_record
        <where>
            <if test="platformId != null">
                and platform_id = #{platformId}
            </if>
            <if test="lotteryId != null">
                and lottery_id = #{lotteryId}
            </if>
            <if test="userId != null">
                and user_id = #{userId}
            </if>
            <if test="issueNo != null and issueNo != ''">
                and issue_no = #{issueNo}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="playTypeCode != null">
                and play_type_code = #{playTypeCode}
            </if>
            <if test="playTypeDetailCode != null and playTypeDetailCode != ''">
                and play_type_detail_code = #{playTypeDetailCode}
            </if>
            <if test="beginTime != null">
                and create_time &gt;= #{beginTime}
            </if>
            <if test="endTime != null">
                and create_time &lt; #{endTime}
            </if>
        </where>
        group by user_id
    </select>

    <select id="statBetRecordAndGroupByDate" parameterType="com.ruoyi.system.domain.BetRecord"
            resultType="com.ruoyi.system.pojo.BetRecordDateStatVO">
        select date (create_time) as betDate, user_id as userId, count (*) as totalCount, sum (bet_amount) as totalAmount, sum (valid_bet_amount) as totalValidBetAmount
                , sum (win_lose_amount) as winLoseAmount, sum (win_amount) as totalWinAmount
        from t_bet_record
        <where>
            <if test="platformId != null">
                and platform_id = #{platformId}
            </if>
            <if test="lotteryId != null">
                and lottery_id = #{lotteryId}
            </if>
            <if test="userId != null">
                and user_id = #{userId}
            </if>
            <if test="issueNo != null and issueNo != ''">
                and issue_no = #{issueNo}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="playTypeCode != null">
                and play_type_code = #{playTypeCode}
            </if>
            <if test="playTypeDetailCode != null and playTypeDetailCode != ''">
                and play_type_detail_code = #{playTypeDetailCode}
            </if>
            <if test="beginTime != null">
                and create_time &gt;=#{beginTime}
            </if>
            <if test="endTime != null">
                and create_time
               &lt;#{endTime}
            </if>
        </where>
        group by date (create_time)
        order by betDate desc
    </select>

    <select id="statBetRecordAndGroupByLotteryId" parameterType="com.ruoyi.system.domain.BetRecord"
            resultType="com.ruoyi.system.pojo.BetRecordStatVO">
        select lottery_id            as lotteryId
             , count(*)              as totalCount
             , sum(bet_amount)       as totalAmount
             , sum(valid_bet_amount) as totalValidBetAmount
             , sum(win_lose_amount)  as winLoseAmount
             , sum(win_amount)       as totalWinAmount
        from t_bet_record
        <where>
            <if test="platformId != null">
                and platform_id = #{platformId}
            </if>
            <if test="lotteryId != null">
                and lottery_id = #{lotteryId}
            </if>
            <if test="userId != null">
                and user_id = #{userId}
            </if>
            <if test="issueNo != null and issueNo != ''">
                and issue_no = #{issueNo}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="playTypeCode != null">
                and play_type_code = #{playTypeCode}
            </if>
            <if test="playTypeDetailCode != null and playTypeDetailCode != ''">
                and play_type_detail_code = #{playTypeDetailCode}
            </if>
            <if test="beginTime != null">
                and create_time &gt;= #{beginTime}
            </if>
            <if test="endTime != null">
                and create_time &lt; #{endTime}
            </if>
        </where>
        group by lottery_id
    </select>

    <select id="statBetRecordAndGroupByPlayTypeCode" parameterType="com.ruoyi.system.domain.BetRecord"
            resultType="com.ruoyi.system.pojo.BetRecordStatVO">
        select play_type_code        as playTypeCode
             , count(*)              as totalCount
             , sum(bet_amount)       as totalAmount
             , sum(valid_bet_amount) as totalValidBetAmount
             , sum(win_lose_amount)  as winLoseAmount
             , sum(win_amount)       as totalWinAmount
        from t_bet_record
        <where>
            <if test="platformId != null">
                and platform_id = #{platformId}
            </if>
            <if test="lotteryId != null">
                and lottery_id = #{lotteryId}
            </if>
            <if test="userId != null">
                and user_id = #{userId}
            </if>
            <if test="issueNo != null and issueNo != ''">
                and issue_no = #{issueNo}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="playTypeCode != null">
                and play_type_code = #{playTypeCode}
            </if>
            <if test="playTypeDetailCode != null and playTypeDetailCode != ''">
                and play_type_detail_code = #{playTypeDetailCode}
            </if>
            <if test="beginTime != null">
                and create_time &gt;= #{beginTime}
            </if>
            <if test="endTime != null">
                and create_time &lt; #{endTime}
            </if>
        </where>
        group by play_type_code
    </select>


    <select id="statBetRecordAndGroupByPlayTypeDetailCode" parameterType="com.ruoyi.system.domain.BetRecord"
            resultType="com.ruoyi.system.pojo.BetRecordStatVO">
        select play_type_detail_code as playTypeDetailCode
             , count(*)              as totalCount
             , sum(bet_amount)       as totalAmount
             , sum(valid_bet_amount) as totalValidBetAmount
             , sum(win_lose_amount)  as winLoseAmount
             , sum(win_amount)       as totalWinAmount
        from t_bet_record
        <where>
            <if test="platformId != null">
                and platform_id = #{platformId}
            </if>
            <if test="lotteryId != null">
                and lottery_id = #{lotteryId}
            </if>
            <if test="userId != null">
                and user_id = #{userId}
            </if>
            <if test="issueNo != null and issueNo != ''">
                and issue_no = #{issueNo}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="playTypeCode != null">
                and play_type_code = #{playTypeCode}
            </if>
            <if test="playTypeDetailCode != null and playTypeDetailCode != ''">
                and play_type_detail_code = #{playTypeDetailCode}
            </if>
            <if test="beginTime != null">
                and create_time &gt;= #{beginTime}
            </if>
            <if test="endTime != null">
                and create_time &lt; #{endTime}
            </if>
        </where>
        group by play_type_detail_code
    </select>


    <select id="getPlayTypeList" resultType="com.ruoyi.system.domain.vo.LotteryBetDataVO">
        SELECT MAX(lottery_id)     AS lotteryId,
               MAX(lottery_name)   AS lotteryName,
               play_type_code      AS playTypeCode,
               MAX(play_type_name) AS playTypeName,   -- 取分组内最大值（其实只有一个）
               COUNT(*)            AS totalCount,     -- 每组记录数
               SUM(bet_amount)     AS totalBetAmount, -- 每组下注金额合计,
               SUM(can_win_amount) AS canWinAmount
        FROM t_bet_record
        WHERE lottery_id = #{lotteryId}
          AND issue_no = #{issueNo}
        GROUP BY play_type_code
        ORDER BY totalBetAmount DESC
    </select>

    <select id="statLotteryDataList" resultType="com.ruoyi.system.domain.vo.LotteryBetDataVO">
        SELECT MAX(a.lottery_id)       AS lotteryId,
               MAX(a.lottery_name)     AS lotteryName,
               a.play_type_code        AS playTypeCode,
               MAX(a.play_type_name)   AS playTypeName,
               a.play_type_detail_code AS playTypeDetailCode,
               (SELECT GROUP_CONCAT(
                               (SELECT GROUP_CONCAT(b1.VALUE ORDER BY FIELD(b1.CODE, SUBSTRING_INDEX(parts.part, ',', - 1)) SEPARATOR ',')
                                FROM t_play_type_detail b1
                                WHERE FIND_IN_SET(b1.CODE, parts.part) > 0)
                                   ORDER BY parts.pos SEPARATOR '|'
                       )
                FROM (SELECT SUBSTRING_INDEX(SUBSTRING_INDEX(a.play_type_detail_code, '|', numbers.n), '|',
                                             - 1) AS part,
                             numbers.n            AS pos
                      FROM (SELECT 1 AS n
                            UNION ALL
                            SELECT 2
                            UNION ALL
                            SELECT 3
                            UNION ALL
                            SELECT 4
                            UNION ALL
                            SELECT 5) numbers
                      WHERE numbers.n &lt;=
                            LENGTH(a.play_type_detail_code) - LENGTH(REPLACE(a.play_type_detail_code, '|', '')) +
                            1) parts)  AS `value`,
               (SELECT GROUP_CONCAT(
                               (SELECT GROUP_CONCAT(b2.description ORDER BY FIELD(b2.CODE, SUBSTRING_INDEX(parts.part, ',', - 1)) SEPARATOR ',')
                                FROM t_play_type_detail b2
                                WHERE FIND_IN_SET(b2.CODE, parts.part) > 0)
                                   ORDER BY parts.pos SEPARATOR '|'
                       )
                FROM (SELECT SUBSTRING_INDEX(SUBSTRING_INDEX(a.play_type_detail_code, '|', numbers.n), '|',
                                             - 1) AS part,
                             numbers.n            AS pos
                      FROM (SELECT 1 AS n
                            UNION ALL
                            SELECT 2
                            UNION ALL
                            SELECT 3
                            UNION ALL
                            SELECT 4
                            UNION ALL
                            SELECT 5) numbers
                      WHERE numbers.n &lt;=
                            LENGTH(a.play_type_detail_code) - LENGTH(REPLACE(a.play_type_detail_code, '|', '')) +
                            1) parts)  AS description,
               COUNT(*)                AS totalCount,
               SUM(a.bet_amount)       AS totalBetAmount,
               SUM(a.can_win_amount)   AS canWinAmount
        FROM t_bet_record a
        WHERE a.lottery_id = #{lotteryId}
          AND a.issue_no = #{issueNo}
          AND a.play_type_code = #{playTypeCode}
        GROUP BY a.play_type_detail_code
        ORDER BY totalBetAmount DESC
    </select>

    <select id="realTimeOrderByNumber" resultType="com.ruoyi.system.domain.vo.RealTimeOrderVO">
        SELECT MAX(br.bet_content)        AS number,
               br.play_type_detail_code   AS playTypeDetailCode,
               COUNT(DISTINCT br.user_id) AS userCount,
               COUNT(*)                   AS orderCount,
               SUM(br.bet_amount)         AS totalBetAmount,
               SUM(br.can_win_amount)     AS totalWinAmount,
               RIGHT(MAX(br.bet_content),1) AS mantissa,
        -- 去掉颜色、生肖
            CONCAT(
            CASE
            WHEN CAST (MAX (br.bet_content) AS UNSIGNED) = 49 THEN '和'
            WHEN CAST (MAX (br.bet_content) AS UNSIGNED) >= 25 THEN '大'
            ELSE '小'
            END, '/', CASE
            WHEN CAST (MAX (br.bet_content) AS UNSIGNED) = 49 THEN '和'
            WHEN CAST (MAX (br.bet_content) AS UNSIGNED) % 2 = 0 THEN '双'
            ELSE '单'
            END
            ) AS type,
        FROM t_bet_record br
        WHERE br.lottery_id = #{lotteryId}
          AND br.play_type_code = #{playTypeCode}
          AND br.play_type_detail_code BETWEEN 1
          AND 49
        <if test="userId != null">
            AND br.user_id = #{userId}
        </if>
        <if test="issueNo != null and issueNo != ''">
            AND br.issue_no = #{issueNo}
        </if>
        GROUP BY br.play_type_detail_code
        HAVING SUM (br.bet_amount) IS NOT NULL
           AND SUM (br.bet_amount)
             > 0
        ORDER BY totalBetAmount DESC
    </select>

    <select id="realTimeOrderBySx" resultType="com.ruoyi.system.domain.vo.RealTimeOrderVO">
        SELECT base.sx,
               IFNULL(sx_numbers.numbers, '')   AS number,
               COALESCE(t.userCount, 0)         AS userCount,
               COALESCE(t.orderCount, 0)        AS orderCount,
               COALESCE(t.totalBetAmount, 0)    AS totalBetAmount,
               COALESCE(t.totalCanWinAmount, 0) AS totalWinAmount
        FROM
        (SELECT '鼠' AS sx
         UNION ALL
         SELECT '牛'
         UNION ALL
         SELECT '虎'
         UNION ALL
         SELECT '兔'
         UNION ALL
         SELECT '龙'
         UNION ALL
         SELECT '蛇'
         UNION ALL
         SELECT '马'
         UNION ALL
         SELECT '羊'
         UNION ALL
         SELECT '猴'
         UNION ALL
         SELECT '鸡'
         UNION ALL
         SELECT '狗'
         UNION ALL
         SELECT '猪') base
            LEFT JOIN (
        SELECT br.bet_content             AS sx,
               COUNT(DISTINCT br.user_id) AS userCount,
               COUNT(*)                   AS orderCount,
               SUM(br.bet_amount)         AS totalBetAmount,
               SUM(br.can_win_amount)     AS totalWinAmount
        FROM t_bet_record br
        WHERE br.lottery_id = #{lotteryId}
          AND br.play_type_code = #{playTypeCode}
          AND br.play_type_detail_code BETWEEN 1130 AND 1141
        <if test="userId != null">
            AND br.user_id = #{userId}
        </if>
        <if test="issueNo != null and issueNo != ''">
            AND br.issue_no = #{issueNo}
        </if>
        GROUP BY br.bet_content
        ) t ON base.sx = t.sx
            LEFT JOIN (SELECT sx, GROUP_CONCAT(number ORDER BY number ASC) AS numbers
                       FROM t_lottery_relation
                       WHERE `year` = 2025
                       GROUP BY sx) sx_numbers ON base.sx = sx_numbers.sx
        GROUP BY base.sx
        ORDER BY totalBetAmount DESC,
                 FIELD(base.sx, '鼠', '牛', '虎', '兔', '龙', '蛇', '马', '羊', '猴', '鸡', '狗', '猪');
    </select>

    <select id="realTimeOrderByColour" resultType="com.ruoyi.system.domain.vo.RealTimeOrderVO">
        SELECT MAX(bet_content)        AS colour,
               play_type_detail_code   AS playTypeDetailCode,
               COUNT(DISTINCT user_id) AS userCount,
               COUNT(*)                AS orderCount,
               SUM(bet_amount)         AS totalBetAmount,
               SUM(can_win_amount)     AS totalWinAmount,
               CASE MAX(bet_content)
                   -- 红波基础分类
                   WHEN '红波' THEN '01,02,07,08,12,13,18,19,23,24,29,30,34,35,40,45,46'
                   WHEN '红单' THEN '01,07,13,19,23,29,35,45'
                   WHEN '红双' THEN '02,08,12,18,24,30,34,40,46'
                   WHEN '红大' THEN '29,30,34,35,40,45,46'
                   WHEN '红小' THEN '01,02,07,08,12,13,18,19,23,24'
                   -- 红波组合分类
                   WHEN '红大单' THEN '29,35,45'
                   WHEN '红大双' THEN '30,34,40,46'
                   WHEN '红小单' THEN '01,07,13,19,23'
                   WHEN '红小双' THEN '02,08,12,18,24'
                   -- 蓝波基础分类
                   WHEN '蓝波' THEN '03,04,09,10,14,15,20,25,26,31,36,37,41,42,47,48'
                   WHEN '蓝单' THEN '03,09,15,25,31,37,41,47'
                   WHEN '蓝双' THEN '04,10,14,20,26,36,42,48'
                   WHEN '蓝大' THEN '25,26,31,36,37,41,42,47,48'
                   WHEN '蓝小' THEN '03,04,09,10,14,15,20'
                   -- 蓝波组合分类
                   WHEN '蓝大单' THEN '25,31,37,41,47'
                   WHEN '蓝大双' THEN '26,36,42,48'
                   WHEN '蓝小单' THEN '03,09,15'
                   WHEN '蓝小双' THEN '04,10,14,20'
                   -- 绿波基础分类
                   WHEN '绿波' THEN '05,06,11,16,17,21,22,27,28,32,33,38,39,43,44,49'
                   WHEN '绿单' THEN '05,11,17,21,27,33,39,43'
                   WHEN '绿双' THEN '06,16,22,28,32,38,44'
                   WHEN '绿大' THEN '27,28,32,33,38,39,43,44'
                   WHEN '绿小' THEN '05,06,11,16,17,21,22'
                   -- 绿波组合分类
                   WHEN '绿大单' THEN '27,33,39,43'
                   WHEN '绿大双' THEN '28,32,38,44'
                   WHEN '绿小单' THEN '05,11,17,21'
                   WHEN '绿小双' THEN '06,16,22'
                   ELSE ''
                   END                 AS number
        FROM t_bet_record br
        WHERE lottery_id = #{lotteryId}
          AND play_type_code IN (1, 6)
          AND (
            play_type_detail_code BETWEEN 65 AND 67
                OR play_type_detail_code BETWEEN 769 AND 811
                OR play_type_detail_code BETWEEN 1229 AND 1240
            )
        <if test="userId != null">
            AND br.user_id = #{userId}
        </if>
        <if test="issueNo != null and issueNo != ''">
            AND br.issue_no = #{issueNo}
        </if>
        GROUP BY play_type_detail_code
        HAVING SUM(bet_amount) > 0
        ORDER BY totalBetAmount DESC
    </select>

    <select id="realTimeOrderByType" resultType="com.ruoyi.system.domain.vo.RealTimeOrderVO">
        SELECT MAX(bet_content)        AS type,
               play_type_detail_code   AS playTypeDetailCode,
               COUNT(DISTINCT user_id) AS userCount,
               COUNT(*)                AS orderCount,
               SUM(bet_amount)         AS totalBetAmount,
               SUM(can_win_amount)     AS totalWinAmount,
               CASE
                   MAX(bet_content)
                   WHEN '大' THEN
                       '25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48'
                   WHEN '小' THEN
                       '01,02,03,04,05,06,07,08,09,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24'
                   WHEN '单' THEN
                       '01,03,05,07,09,11,13,15,17,19,21,23,25,27,29,31,33,35,37,39,41,43,45,47'
                   WHEN '双' THEN
                       '02,04,06,08,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48'
                   ELSE
                       '和'
                   END                 AS number
        FROM t_bet_record br
        WHERE lottery_id = #{lotteryId}
          AND play_type_code IN (1)
          AND (play_type_detail_code BETWEEN 55 AND 58)
        GROUP BY play_type_detail_code
        HAVING SUM(bet_amount) > 0
        ORDER BY totalBetAmount DESC
    </select>

    <select id="realTimeOrderByPtyx" resultType="com.ruoyi.system.domain.vo.RealTimeOrderVO">
        SELECT base.sx,
               IFNULL(sx_numbers.numbers, '')   AS number,
               COALESCE(t.userCount, 0)         AS userCount,
               COALESCE(t.orderCount, 0)        AS orderCount,
               COALESCE(t.totalBetAmount, 0)    AS totalBetAmount,
               COALESCE(t.totalCanWinAmount, 0) AS totalWinAmount
        FROM
        (SELECT '鼠' AS sx
         UNION ALL
         SELECT '牛'
         UNION ALL
         SELECT '虎'
         UNION ALL
         SELECT '兔'
         UNION ALL
         SELECT '龙'
         UNION ALL
         SELECT '蛇'
         UNION ALL
         SELECT '马'
         UNION ALL
         SELECT '羊'
         UNION ALL
         SELECT '猴'
         UNION ALL
         SELECT '鸡'
         UNION ALL
         SELECT '狗'
         UNION ALL
         SELECT '猪') base
            LEFT JOIN (
        SELECT br.bet_content             AS sx,
               COUNT(DISTINCT br.user_id) AS userCount,
               COUNT(*)                   AS orderCount,
               SUM(br.bet_amount)         AS totalBetAmount,
               SUM(br.can_win_amount)     AS totalWinAmount
        FROM t_bet_record br
        WHERE br.lottery_id = #{lotteryId}
          AND br.play_type_code = #{playTypeCode}
          AND br.play_type_detail_code BETWEEN 1118 AND 1129
        <if test="userId != null">
            AND br.user_id = #{userId}
        </if>
        <if test="issueNo != null and issueNo != ''">
            AND br.issue_no = #{issueNo}
        </if>
        GROUP BY br.bet_content
        ) t ON base.sx = t.sx
            LEFT JOIN (SELECT sx, GROUP_CONCAT(number ORDER BY number ASC) AS numbers
                       FROM t_lottery_relation
                       WHERE `year` = 2025
                       GROUP BY sx) sx_numbers ON base.sx = sx_numbers.sx
        GROUP BY base.sx
        ORDER BY totalBetAmount DESC,
                 FIELD(base.sx, '鼠', '牛', '虎', '兔', '龙', '蛇', '马', '羊', '猴', '鸡', '狗', '猪');
    </select>

    <select id="realTimeOrderByMantissa" resultType="com.ruoyi.system.domain.vo.RealTimeOrderVO">
        SELECT REPLACE(MAX(bet_content), '尾数@', '') AS mantissa,
               play_type_detail_code                  AS playTypeDetailCode,
               COUNT(DISTINCT user_id)                AS userCount,        -- 独立用户数
               COUNT(*)                               AS orderCount,       -- 总投注笔数
               SUM(bet_amount)                        AS totalBetAmount,   -- 总投注金额
               SUM(can_win_amount)                    AS totalWinAmount -- 总可赢金额
        FROM t_bet_record br
        WHERE lottery_id = #{lotteryId}
          AND play_type_code = 1
          AND play_type_detail_code BETWEEN 1219
            AND 1228
        GROUP BY play_type_detail_code
        HAVING SUM(bet_amount) > 0
        ORDER BY totalBetAmount DESC
    </select>
</mapper>
